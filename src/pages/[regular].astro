---
import Base from "@/layouts/Base.astro";
import { getSinglePage } from "@/lib/contentParser.astro";
import CallToAction from "@/partials/CallToAction.astro";
import PageHeader from "@/partials/PageHeader.astro";
import { render } from "astro:content";

// get static paths for all pages
export async function getStaticPaths() {
  const COLLECTION_FOLDER = "pages";

  const pages = await getSinglePage(COLLECTION_FOLDER);

  return pages.map((page) => ({
    params: { regular: page.id },
    props: { page },
  }));
}

// Ensure Astro.props is awaited in a function
const getPageData = async () => {
  const { page } = Astro.props ?? {};
  if (!page || !page.data) {
    console.error("Page data is missing!", page);
    throw new Error("Page not found or missing data.");
  }
  return { 
    page, 
    content: await render(page) 
  };
};

const { page, content } = await getPageData();
const { title, meta_title, description, image } = page.data;
---

<Base
  title={title}
  meta_title={meta_title}
  description={description}
  image={image}
>
  <section class="ph-spacing">
    <PageHeader title={title} />
  </section>
  <section class="section-sm">
    <div class="container">
      <div class="row justify-center">
        <div class="lg:col-10">
          <div class="content" data-aos="fade-up-sm" data-aos-delay="200">
            <content.Content />
          </div>
        </div>
      </div>
    </div>
  </section>
  <CallToAction hasBackground={true} />
</Base>
